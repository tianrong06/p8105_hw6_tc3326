---
title: "p8105_hw6_tc3326"
author: "KK Chen"
date: "2024-12-02"
output: github_document
---

```{r}
library(tidyverse)
library(modelr)
```

## Problem 2 
Import and Read the data
```{r}
homicides = read_csv("./data/homicide-data.csv", na = c(".", "", "NA"))
```

Data processing
```{r}
homicides_clean <- homicides %>%
  mutate(
    city_state = paste(city, state, sep = ", "),
    solved_binary = ifelse(disposition %in% c("Closed without arrest", "Open/No arrest"), 0, 1)
  ) %>%
  filter(
    !(city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL")),
    victim_race %in% c("White", "Black")
  ) %>%
  mutate(victim_age = as.numeric(victim_age)) %>%
  drop_na(victim_age)
```

Logistic Regression for Baltimore
```{r}
baltimore_model <- homicides_clean %>%
  filter(city_state == "Baltimore, MD") %>%
  glm(solved_binary ~ victim_age + victim_sex + victim_race, data = ., family = binomial)

baltimore_results <- broom::tidy(baltimore_model) %>%
  mutate(odds_ratio = exp(estimate))

baltimore_ci <- exp(confint(baltimore_model))
baltimore_or <- baltimore_results %>%
  filter(term == "victim_sexMale") %>%
  summarize(
    odds_ratio = odds_ratio,
    ci_lower = baltimore_ci["victim_sexMale", 1],
    ci_upper = baltimore_ci["victim_sexMale", 2]
  )

baltimore_or
```

Logistic Regression for All Cities
```{r}
city_model_results <- homicides_clean %>%
  group_by(city_state) %>%
  nest() %>%
  mutate(
    city_model = map(data, ~ glm(solved_binary ~ victim_age + victim_sex + victim_race, data = ., family = binomial)),
    city_or_ci = map(city_model, function(model) {
      model_tidy <- broom::tidy(model) %>%
        mutate(odds_ratio = exp(estimate))
      ci <- exp(confint(model))
      sex_ci <- ci["victim_sexMale", ]
      model_tidy %>%
        filter(term == "victim_sexMale") %>%
        summarize(
          odds_ratio = odds_ratio,
          ci_lower = sex_ci[1],
          ci_upper = sex_ci[2]
        )
    })
  ) %>%
  select(city_state, city_or_ci) %>%
  unnest(city_or_ci)

city_model_results %>%
  knitr::kable(
    digits = 3,
    format = "markdown"
  )
```

Plot of ORs and CIs by City
```{r}
city_model_results %>%
  ggplot(aes(x = reorder(city_state, odds_ratio), y = odds_ratio)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 0.2) +
  coord_flip() +
  geom_hline(yintercept = 1, linetype = "dashed", color = "red") +
  labs(
    title = "Estimated Odds Ratios and Confidence Intervals by City",
    caption = "Adjusted Odds Ratios for Solving Homicides (Male vs Female Victims)",
    x = "City",
    y = "Adjusted Odds Ratio (95% CI)"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 10),
    axis.title = element_text(size = 12),
    plot.title = element_text(hjust = 0.5, size = 14)
  )
```

* In six cities: Albuquerque, Stockton, Fresno, Nashville, Richmond, and 
Atlanta, male victims are more likely to have cases solved. In most cities, male victims are less likely to have their cases solved compared to female victims. 

## Problem 3
Import and Clean data
```{r}
birthweight_data <- read_csv("./data/birthweight.csv", na = c(".", "", "NA")) %>%
  mutate(
    baby_sex = factor(babysex, levels = c(1, 2), labels = c("Male", "Female")),
    father_race = factor(frace, levels = c(1, 2, 3, 4, 8, 9), labels = c("White", "Black", "Asian", "Puerto Rican", "Other", "Unknown")),
    mother_race = factor(mrace, levels = c(1, 2, 3, 4, 8), labels = c("White", "Black", "Asian", "Puerto Rican", "Other")),
    malformations = factor(malform, levels = c(0, 1), labels = c("Absent", "Present"))
  )

# Check for missing data
colSums(is.na(birthweight_data))
```

Stepwise regression to propose a model
```{r}
full_model <- lm(bwt ~ ., data = birthweight_data)
stepwise_model <- step(full_model, direction = "both")

summary (stepwise_model)

final_model <- lm(bwt ~ baby_sex + bhead + blength + delwt + fincome + gaweeks + mheight + mother_race + parity + ppwt + smoken, data = birthweight_data)

summary(final_model)
```

* Started with a full model including all predictors. Used stepwise regression (forward and backward selection) to identify significant predictors. Final model included variables related to baby characteristics, maternal factors, gestational age, socioeconomic status, and parity. Achieved an adjusted R-squared of 0.7173 and residual standard error of 272.3 grams.

Add predictions and residuals to the data for plotting
```{r}
birthweight_data <- birthweight_data %>%
  add_predictions(final_model, var = "fitted_values") %>%
  add_residuals(final_model, var = "residuals")

# Plot residuals vs fitted values
ggplot(birthweight_data, aes(x = fitted_values, y = residuals)) +
  geom_point(size = 0.7, alpha = 0.3) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(
    title = "Residuals vs Fitted Values",
    x = "Fitted Values",
    y = "Residuals"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))
```





